apiVersion: apps/v1
kind: Deployment
metadata:
  name: deepseek-r1
  namespace: llm-model
  labels:
    app: deepseek-r1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deepseek-r1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        app: deepseek-r1
        alibabacloud.com/compute-class: gpu
        alibabacloud.com/gpu-model-series: PPU810E
        alibabacloud.com/compute-qos: default
        app: deepseek-r1
    spec:
      imagePullSecrets:
      - name: acs-image-secret
      containers:
      - name: llm-ds-r1
        image: egslingjun-registry.cn-wulanchabu.cr.aliyuncs.com/egslingjun/inference-xpu-pytorch:25.03-v1.4.3-hotfix-vllm0.7.3-torch2.5-cu123-20250331
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - "vllm serve /model/DeepSeek-R1-GPTQ-INT8 --port 8000 --trust-remote-code --served-model-name ds --max-model-len 128000 --quantization moe_wna16 --gpu-memory-utilization 0.98 --tensor-parallel-size 16 --enforce-eager"
        resources:
          limits:
            cpu: 176
            memory: 1800G
            alibabacloud.com/ppu: 16
            ephemeral-storage: 200Gi
          requests:
            cpu: 176
            memory: 1800G
            alibabacloud.com/ppu: 16
            ephemeral-storage: 200Gi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - name: llm-model
          mountPath: /model
        - mountPath: /dev/shm
          name: cache-volume
        - mountPath: /ppu-data
          name: ephemeral
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes:
      - name: llm-model
        persistentVolumeClaim:
          claimName: llm-model
      - name: cache-volume
        emptyDir:
          medium: Memory
          sizeLimit: 500G
      - name: ephemeral
        emptyDir:
          sizeLimit: 200G