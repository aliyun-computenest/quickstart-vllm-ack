ROSTemplateFormatVersion: '2015-09-01'
Description:
  en: 新建ACK部署Knative,并用vllm部署大模型
  zh-cn: New ack deployment Knative and use vllm deploy llm.
Conditions:
  ShouldAddAuthHeader:
    Fn::Not:
      Fn::Equals:
        - Ref: VllmApiKey
        - ''
  IsPublicEnabled:
    Fn::Equals:
      - Ref: SupportPublicAccess
      - true
Parameters:
  VllmApiKey:
    Type: 'String'
    Description:
      en: 'The API key for VLLM authentication. It is recommended to configure the ApiKey when accessing the public network.'
      zh-cn: VLLM API密钥，建议开公网访问时配置该ApiKey。
    Label:
      en: VLLM API Key
      zh-cn: VLLM API密钥
    NoEcho: true
    MaxLength: '256'
    Default: ''
  SupportPublicAccess:
    Type: Boolean
    Label:
      zh-cn: 支持公网访问
      en: Support Public Access
Resources:
Outputs:
  PrivateAPIUserInstructions:
    Label: 私网Api调用使用说明
    Description: 私网Api调用使用说明，通过以下命令发送HTTP请求访问推理服务，修改prompt的内容，即可自定义和推理服务交互的内容
    Value:
      Fn::Sub:
        - 'curl -X POST "http://${PrivateIp}/v1/chat/completions" -H "Host: llm-model.llm-model.svc.cluster.local" -H "Content-Type: application/json" ${AuthHeader} --data ''{ "model": "${ModelName}", "messages": [ { "role": "user", "content": "Tell me the recipe for tea" } ] }'''
        - PrivateIp: 12.22.22.22
          ModelName: "deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"
          VllmApiKey: !Ref VllmApiKey
          AuthHeader:
            Fn::If:
              - ShouldAddAuthHeader
              - Fn::Sub:
                - '-H "Authorization: Bearer ${VllmApiKey}"'
                - VllmApiKey: !Ref VllmApiKey
              - ""
  PublicAPIUserInstructions:
    Condition: IsPublicEnabled
    Label: 公网API调用示例
    Description: 通过公网IP调用服务（部署时建议严格限制源IP）
    Value:
      Fn::Sub:
        - 'curl -X POST "http://${PublicIP}/v1/chat/completions" -H "Host: llm-model.llm-model.example.com" -H "Content-Type: application/json" ${AuthHeader} --data ''{ "model": "${ModelName}", "messages": [ { "role": "user", "content": "Tell me the recipe for tea" } ] }'''
        - PublicIP: 22.22.22.22
          ModelName: "deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"
          VllmApiKey: !Ref VllmApiKey
          AuthHeader:
            Fn::If:
              - ShouldAddAuthHeader
              - Fn::Sub:
                - '-H "Authorization: Bearer ${VllmApiKey}"'
                - VllmApiKey: !Ref VllmApiKey
              - ''
Metadata:
  ALIYUN::ROS::Interface:
    ParameterGroups:
      - Parameters:
          - SupportPublicAccess
          - VllmApiKey
        Label:
          en: 访问配置
          zh-cn: 访问配置